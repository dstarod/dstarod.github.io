

<!DOCTYPE html>
<html lang="ru" itemscope itemtype="http://schema.org/WebPage">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <script type="text/javascript" >
      (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
      m[i].l=1*new Date();
      for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
      k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
      (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
      ym(103109520, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true
      });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/103109520" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 


      <title>Postgres: generate the most large followers intersections - </title>

  <meta name="description" content="Задача: получить список пользователей твиттера, с которыми у одного из них есть общие фоловеры, и отсортировать по их количеству. Лучше всего продемонстрировать на примере. Создадим таблицу с идентификаторами пользователей и фоловеров:
CREATE TEMP TABLE f(uid INT, fid INT);
INSERT INTO f(uid, fid) VALUES
    (1, 10), (1, 11), (1, 12), (1, 13), (1, 14),
    (2, 10), (2, 11), (2, 12),
    (3, 13), (3, 14),
    (4, 13), (4, 14), (4, 10), (4, 11)
;
А вот собственно и запрос, интересуют пересечения с пользователем 2, самые большие сверху.
SELECT uid, array_agg(fid) followers_intersect
FROM f GROUP BY uid
ORDER BY cardinality(
    (
        SELECT array_agg(a1) FROM unnest(array_agg(fid)) a1
        INNER JOIN unnest(
            (SELECT array_agg(fid) FROM f WHERE uid=2)::INT[]
        ) a2
        ON a1=a2
    )::INT[]
) DESC NULLS LAST;
Результат, как и ожидалось:"><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Круг интересов",
    
    "url": "\/\/localhost:1313\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "\/\/localhost:1313\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "\/\/localhost:1313\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "\/\/localhost:1313\/posts\/postgres-generate-most-large-followers\/",
          "name": "Postgres generate the most large followers intersections"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : ""
  },
  "headline": "Postgres: generate the most large followers intersections",
  "description" : "Задача: получить список пользователей твиттера, с которыми у одного из них есть общие фоловеры, и отсортировать по их количеству. Лучше всего продемонстрировать на примере. Создадим таблицу с идентификаторами пользователей и фоловеров:\nCREATE TEMP TABLE f(uid INT, fid INT); INSERT INTO f(uid, fid) VALUES (1, 10), (1, 11), (1, 12), (1, 13), (1, 14), (2, 10), (2, 11), (2, 12), (3, 13), (3, 14), (4, 13), (4, 14), (4, 10), (4, 11) ; А вот собственно и запрос, интересуют пересечения с пользователем 2, самые большие сверху.\nSELECT uid, array_agg(fid) followers_intersect FROM f GROUP BY uid ORDER BY cardinality( ( SELECT array_agg(a1) FROM unnest(array_agg(fid)) a1 INNER JOIN unnest( (SELECT array_agg(fid) FROM f WHERE uid=2)::INT[] ) a2 ON a1=a2 )::INT[] ) DESC NULLS LAST; Результат, как и ожидалось:\n",
  "inLanguage" : "ru",
  "wordCount":  133 ,
  "datePublished" : "2016-01-19T00:00:00\u002b03:00",
  "dateModified" : "2016-01-19T00:00:00\u002b03:00",
  "image" : "\/\/localhost:1313\/",
  "keywords" : [ "postgres" ],
  "mainEntityOfPage" : "\/\/localhost:1313\/posts\/postgres-generate-most-large-followers\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "\/\/localhost:1313\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "\/\/localhost:1313\/",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="Postgres: generate the most large followers intersections" />
<meta property="og:description" content="Задача: получить список пользователей твиттера, с которыми у одного из них есть общие фоловеры, и отсортировать по их количеству. Лучше всего продемонстрировать на примере. Создадим таблицу с идентификаторами пользователей и фоловеров:
CREATE TEMP TABLE f(uid INT, fid INT);
INSERT INTO f(uid, fid) VALUES
    (1, 10), (1, 11), (1, 12), (1, 13), (1, 14),
    (2, 10), (2, 11), (2, 12),
    (3, 13), (3, 14),
    (4, 13), (4, 14), (4, 10), (4, 11)
;
А вот собственно и запрос, интересуют пересечения с пользователем 2, самые большие сверху.
SELECT uid, array_agg(fid) followers_intersect
FROM f GROUP BY uid
ORDER BY cardinality(
    (
        SELECT array_agg(a1) FROM unnest(array_agg(fid)) a1
        INNER JOIN unnest(
            (SELECT array_agg(fid) FROM f WHERE uid=2)::INT[]
        ) a2
        ON a1=a2
    )::INT[]
) DESC NULLS LAST;
Результат, как и ожидалось:">
<meta property="og:url" content="//localhost:1313/posts/postgres-generate-most-large-followers/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Круг интересов" />

  <meta name="twitter:title" content="Postgres: generate the most large followers intersections" />
  <meta name="twitter:description" content="Задача: получить список пользователей твиттера, с которыми у одного из них есть общие фоловеры, и отсортировать по их количеству. Лучше всего продемонстрировать на примере. Создадим таблицу с …">
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="generator" content="Hugo 0.147.8">
  <link rel="alternate" href="//localhost:1313/index.xml" type="application/rss+xml" title="Круг интересов"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.6.0/css/all.css" integrity="sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"><link rel="stylesheet" href="//localhost:1313/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="//localhost:1313/css/syntax.css" /><link rel="stylesheet" href="//localhost:1313/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">

  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Навигация</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="//localhost:1313/">Круг интересов</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        

        

        
      </ul>
    </div>

    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="posts-heading">
              
                <h1>Postgres: generate the most large followers intersections</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">

        <p>Задача: получить список пользователей твиттера, с которыми у одного из них есть общие фоловеры, и отсортировать по их количеству. Лучше всего продемонстрировать на примере. Создадим таблицу с идентификаторами пользователей и фоловеров:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">CREATE</span> <span style="color:#268bd2">TEMP</span> <span style="color:#859900">TABLE</span> <span style="color:#268bd2">f</span>(<span style="color:#268bd2">uid</span> <span style="color:#cb4b16">INT</span>, <span style="color:#268bd2">fid</span> <span style="color:#cb4b16">INT</span>);
</span></span><span style="display:flex;"><span><span style="color:#859900">INSERT</span> <span style="color:#859900">INTO</span> <span style="color:#268bd2">f</span>(<span style="color:#268bd2">uid</span>, <span style="color:#268bd2">fid</span>) <span style="color:#859900">VALUES</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#2aa198;font-weight:bold">1</span>, <span style="color:#2aa198;font-weight:bold">10</span>), (<span style="color:#2aa198;font-weight:bold">1</span>, <span style="color:#2aa198;font-weight:bold">11</span>), (<span style="color:#2aa198;font-weight:bold">1</span>, <span style="color:#2aa198;font-weight:bold">12</span>), (<span style="color:#2aa198;font-weight:bold">1</span>, <span style="color:#2aa198;font-weight:bold">13</span>), (<span style="color:#2aa198;font-weight:bold">1</span>, <span style="color:#2aa198;font-weight:bold">14</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#2aa198;font-weight:bold">2</span>, <span style="color:#2aa198;font-weight:bold">10</span>), (<span style="color:#2aa198;font-weight:bold">2</span>, <span style="color:#2aa198;font-weight:bold">11</span>), (<span style="color:#2aa198;font-weight:bold">2</span>, <span style="color:#2aa198;font-weight:bold">12</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#2aa198;font-weight:bold">3</span>, <span style="color:#2aa198;font-weight:bold">13</span>), (<span style="color:#2aa198;font-weight:bold">3</span>, <span style="color:#2aa198;font-weight:bold">14</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#2aa198;font-weight:bold">4</span>, <span style="color:#2aa198;font-weight:bold">13</span>), (<span style="color:#2aa198;font-weight:bold">4</span>, <span style="color:#2aa198;font-weight:bold">14</span>), (<span style="color:#2aa198;font-weight:bold">4</span>, <span style="color:#2aa198;font-weight:bold">10</span>), (<span style="color:#2aa198;font-weight:bold">4</span>, <span style="color:#2aa198;font-weight:bold">11</span>)
</span></span><span style="display:flex;"><span>;
</span></span></code></pre></div><p>А вот собственно и запрос, интересуют пересечения с пользователем 2, самые большие сверху.</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#859900">SELECT</span> <span style="color:#268bd2">uid</span>, <span style="color:#268bd2">array_agg</span>(<span style="color:#268bd2">fid</span>) <span style="color:#268bd2">followers_intersect</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">FROM</span> <span style="color:#268bd2">f</span> <span style="color:#859900">GROUP</span> <span style="color:#859900">BY</span> <span style="color:#268bd2">uid</span>
</span></span><span style="display:flex;"><span><span style="color:#859900">ORDER</span> <span style="color:#859900">BY</span> <span style="color:#859900">cardinality</span>(
</span></span><span style="display:flex;"><span>    (
</span></span><span style="display:flex;"><span>        <span style="color:#859900">SELECT</span> <span style="color:#268bd2">array_agg</span>(<span style="color:#268bd2">a1</span>) <span style="color:#859900">FROM</span> <span style="color:#859900">unnest</span>(<span style="color:#268bd2">array_agg</span>(<span style="color:#268bd2">fid</span>)) <span style="color:#268bd2">a1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#859900">INNER</span> <span style="color:#859900">JOIN</span> <span style="color:#859900">unnest</span>(
</span></span><span style="display:flex;"><span>            (<span style="color:#859900">SELECT</span> <span style="color:#268bd2">array_agg</span>(<span style="color:#268bd2">fid</span>) <span style="color:#859900">FROM</span> <span style="color:#268bd2">f</span> <span style="color:#859900">WHERE</span> <span style="color:#268bd2">uid</span>=<span style="color:#2aa198;font-weight:bold">2</span>)::<span style="color:#cb4b16">INT</span>[]
</span></span><span style="display:flex;"><span>        ) <span style="color:#268bd2">a2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#859900">ON</span> <span style="color:#268bd2">a1</span>=<span style="color:#268bd2">a2</span>
</span></span><span style="display:flex;"><span>    )::<span style="color:#cb4b16">INT</span>[]
</span></span><span style="display:flex;"><span>) <span style="color:#859900">DESC</span> <span style="color:#268bd2">NULLS</span> <span style="color:#859900">LAST</span>;
</span></span></code></pre></div><p>Результат, как и ожидалось:</p>
<pre tabindex="0"><code>1. &#34;{10,11,12,13,14}&#34;
2. &#34;{10,11,12}&#34;
4. &#34;{13,14,10,11}&#34;
3. &#34;{13,14}&#34;
</code></pre>

        
          <div class="blog-tags">
            
              
              <a href="//localhost:1313/tags/postgres/">postgres</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
          
            <li class="next">
              <a href="//localhost:1313/posts/python-nltk-stanford-nlp/" data-toggle="tooltip" data-placement="top" title="Python NLTK &#43; Stanford NLP">Следующий &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            2025
          

          
            &nbsp;&bull;&nbsp;
            <a href="//localhost:1313/">Круг интересов</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          На базе <a href="https://gohugo.io">Hugo v0.147.8</a> &nbsp;&bull;&nbsp; Тема <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> на базе <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="//localhost:1313/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="//localhost:1313/js/load-photoswipe.js"></script>










    
  </body>
</html>

