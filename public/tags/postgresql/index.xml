<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Postgresql on Круг интересов</title><link>https://dstarod.github.io/tags/postgresql/</link><description>Recent content in Postgresql on Круг интересов</description><generator>Hugo</generator><language>ru-RU</language><lastBuildDate>Thu, 15 Aug 2019 00:00:00 +0300</lastBuildDate><atom:link href="https://dstarod.github.io/tags/postgresql/index.xml" rel="self" type="application/rss+xml"/><item><title>Использование цикла в PostgreSQL с выводом в консоль</title><link>https://dstarod.github.io/postgres-do-loop-notice/</link><pubDate>Thu, 15 Aug 2019 00:00:00 +0300</pubDate><guid>https://dstarod.github.io/postgres-do-loop-notice/</guid><description>&lt;p>Небольшая заметка на полях на будущее. Иногда в PostgreSQL нужно выполнить ряд повторяющихся действий с выводом результатов в лог.
Одним примером покажу, как это сделать легко и просто.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#93a1a1;font-style:italic">-- Делаем вывод сообщений в лог видимым
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#93a1a1;font-style:italic">&lt;/span>&lt;span style="color:#859900">SET&lt;/span> &lt;span style="color:#268bd2">client_min_messages&lt;/span> &lt;span style="color:#859900">TO&lt;/span> &lt;span style="color:#268bd2">notice&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#859900">CREATE&lt;/span> &lt;span style="color:#268bd2">TEMP&lt;/span> &lt;span style="color:#859900">TABLE&lt;/span> &lt;span style="color:#268bd2">tmp&lt;/span>(&lt;span style="color:#268bd2">id&lt;/span> &lt;span style="color:#cb4b16">SERIAL&lt;/span>, &lt;span style="color:#268bd2">name&lt;/span> &lt;span style="color:#cb4b16">TEXT&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#93a1a1;font-style:italic">-- Анонимный блок DO
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#93a1a1;font-style:italic">&lt;/span>&lt;span style="color:#859900">DO&lt;/span> $$
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#859900">BEGIN&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#93a1a1;font-style:italic">-- Цикл LOOP
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#93a1a1;font-style:italic">&lt;/span> &lt;span style="color:#268bd2">LOOP&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#859900">INSERT&lt;/span> &lt;span style="color:#859900">INTO&lt;/span> &lt;span style="color:#268bd2">tmp&lt;/span>(&lt;span style="color:#268bd2">name&lt;/span>) &lt;span style="color:#859900">VALUES&lt;/span>(&lt;span style="color:#268bd2">gen_random_uuid&lt;/span>()::&lt;span style="color:#cb4b16">TEXT&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#93a1a1;font-style:italic">-- Условный оператор IF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#93a1a1;font-style:italic">&lt;/span> &lt;span style="color:#859900">IF&lt;/span> (&lt;span style="color:#859900">SELECT&lt;/span> &lt;span style="color:#859900">MAX&lt;/span>(&lt;span style="color:#268bd2">id&lt;/span>) &lt;span style="color:#859900">FROM&lt;/span> &lt;span style="color:#268bd2">tmp&lt;/span>) &amp;gt; &lt;span style="color:#2aa198;font-weight:bold">100&lt;/span> &lt;span style="color:#859900">THEN&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#268bd2">RAISE&lt;/span> &lt;span style="color:#268bd2">NOTICE&lt;/span> &lt;span style="color:#2aa198">&amp;#39;max id == %&amp;#39;&lt;/span>, (&lt;span style="color:#859900">SELECT&lt;/span> &lt;span style="color:#859900">COUNT&lt;/span>(*) &lt;span style="color:#859900">FROM&lt;/span> &lt;span style="color:#268bd2">tmp&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#268bd2">EXIT&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#859900">END&lt;/span> &lt;span style="color:#859900">IF&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#859900">END&lt;/span> &lt;span style="color:#268bd2">LOOP&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#859900">END&lt;/span> $$;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Postgres: generate the most large followers intersections</title><link>https://dstarod.github.io/postgres-generate-most-large-followers/</link><pubDate>Tue, 19 Jan 2016 00:00:00 +0300</pubDate><guid>https://dstarod.github.io/postgres-generate-most-large-followers/</guid><description>&lt;p>Задача: получить список пользователей твиттера, с которыми у одного из них есть общие фоловеры, и отсортировать по их количеству. Лучше всего продемонстрировать на примере. Создадим таблицу с идентификаторами пользователей и фоловеров:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#859900">CREATE&lt;/span> &lt;span style="color:#268bd2">TEMP&lt;/span> &lt;span style="color:#859900">TABLE&lt;/span> &lt;span style="color:#268bd2">f&lt;/span>(&lt;span style="color:#268bd2">uid&lt;/span> &lt;span style="color:#cb4b16">INT&lt;/span>, &lt;span style="color:#268bd2">fid&lt;/span> &lt;span style="color:#cb4b16">INT&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#859900">INSERT&lt;/span> &lt;span style="color:#859900">INTO&lt;/span> &lt;span style="color:#268bd2">f&lt;/span>(&lt;span style="color:#268bd2">uid&lt;/span>, &lt;span style="color:#268bd2">fid&lt;/span>) &lt;span style="color:#859900">VALUES&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#2aa198;font-weight:bold">1&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">10&lt;/span>), (&lt;span style="color:#2aa198;font-weight:bold">1&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">11&lt;/span>), (&lt;span style="color:#2aa198;font-weight:bold">1&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">12&lt;/span>), (&lt;span style="color:#2aa198;font-weight:bold">1&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">13&lt;/span>), (&lt;span style="color:#2aa198;font-weight:bold">1&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">14&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#2aa198;font-weight:bold">2&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">10&lt;/span>), (&lt;span style="color:#2aa198;font-weight:bold">2&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">11&lt;/span>), (&lt;span style="color:#2aa198;font-weight:bold">2&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">12&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#2aa198;font-weight:bold">3&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">13&lt;/span>), (&lt;span style="color:#2aa198;font-weight:bold">3&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">14&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#2aa198;font-weight:bold">4&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">13&lt;/span>), (&lt;span style="color:#2aa198;font-weight:bold">4&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">14&lt;/span>), (&lt;span style="color:#2aa198;font-weight:bold">4&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">10&lt;/span>), (&lt;span style="color:#2aa198;font-weight:bold">4&lt;/span>, &lt;span style="color:#2aa198;font-weight:bold">11&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>А вот собственно и запрос, интересуют пересечения с пользователем 2, самые большие сверху.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#859900">SELECT&lt;/span> &lt;span style="color:#268bd2">uid&lt;/span>, &lt;span style="color:#268bd2">array_agg&lt;/span>(&lt;span style="color:#268bd2">fid&lt;/span>) &lt;span style="color:#268bd2">followers_intersect&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#859900">FROM&lt;/span> &lt;span style="color:#268bd2">f&lt;/span> &lt;span style="color:#859900">GROUP&lt;/span> &lt;span style="color:#859900">BY&lt;/span> &lt;span style="color:#268bd2">uid&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#859900">ORDER&lt;/span> &lt;span style="color:#859900">BY&lt;/span> &lt;span style="color:#859900">cardinality&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#859900">SELECT&lt;/span> &lt;span style="color:#268bd2">array_agg&lt;/span>(&lt;span style="color:#268bd2">a1&lt;/span>) &lt;span style="color:#859900">FROM&lt;/span> &lt;span style="color:#859900">unnest&lt;/span>(&lt;span style="color:#268bd2">array_agg&lt;/span>(&lt;span style="color:#268bd2">fid&lt;/span>)) &lt;span style="color:#268bd2">a1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#859900">INNER&lt;/span> &lt;span style="color:#859900">JOIN&lt;/span> &lt;span style="color:#859900">unnest&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#859900">SELECT&lt;/span> &lt;span style="color:#268bd2">array_agg&lt;/span>(&lt;span style="color:#268bd2">fid&lt;/span>) &lt;span style="color:#859900">FROM&lt;/span> &lt;span style="color:#268bd2">f&lt;/span> &lt;span style="color:#859900">WHERE&lt;/span> &lt;span style="color:#268bd2">uid&lt;/span>=&lt;span style="color:#2aa198;font-weight:bold">2&lt;/span>)::&lt;span style="color:#cb4b16">INT&lt;/span>[]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ) &lt;span style="color:#268bd2">a2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#859900">ON&lt;/span> &lt;span style="color:#268bd2">a1&lt;/span>=&lt;span style="color:#268bd2">a2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )::&lt;span style="color:#cb4b16">INT&lt;/span>[]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>) &lt;span style="color:#859900">DESC&lt;/span> &lt;span style="color:#268bd2">NULLS&lt;/span> &lt;span style="color:#859900">LAST&lt;/span>;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Результат, как и ожидалось:&lt;/p></description></item></channel></rss>